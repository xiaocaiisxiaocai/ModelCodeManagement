# æœºå‹ç¼–ç ç®¡ç†ç³»ç»Ÿ - ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ï¼ˆå®Œæ•´ç‰ˆ-ä¿®æ­£ï¼‰

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´8æœˆ13æ—¥  
**æ›´æ–°æ—¥æœŸ**: 2025å¹´8æœˆ16æ—¥ï¼ˆä¿®æ­£ç¼–ç ç»“æ„ç†è§£ï¼‰  
**æŠ€æœ¯æ ˆ**: C# + .NET Core 8 + SqlSugar + MySQL  

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#2-ç³»ç»Ÿæ¶æ„è®¾è®¡)
3. [æ•°æ®åº“è®¾è®¡](#3-æ•°æ®åº“è®¾è®¡)
4. [APIè®¾è®¡è§„èŒƒ](#4-apiè®¾è®¡è§„èŒƒ)
5. [æ ¸å¿ƒä¸šåŠ¡é€»è¾‘](#5-æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)
6. [ç¼–ç è§„åˆ™é…ç½®](#6-ç¼–ç è§„åˆ™é…ç½®)
7. [çŠ¶æ€ç®¡ç†ä¸ç›‘æ§](#7-çŠ¶æ€ç®¡ç†ä¸ç›‘æ§)
8. [æœåŠ¡å±‚è®¾è®¡](#8-æœåŠ¡å±‚è®¾è®¡)
9. [æƒé™ç®¡ç†](#9-æƒé™ç®¡ç†)
10. [éƒ¨ç½²æ–¹æ¡ˆ](#10-éƒ¨ç½²æ–¹æ¡ˆ)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 åŸºæœ¬ä¿¡æ¯
- **é¡¹ç›®åç§°**: æœºå‹ç¼–ç ç®¡ç†ç³»ç»Ÿ
- **ä¸šåŠ¡é¢†åŸŸ**: åˆ¶é€ ä¸šç¼–ç ç®¡ç†
- **ç”¨æˆ·è§„æ¨¡**: æ€»ç”¨æˆ·200äººï¼ŒåŒæ—¶åœ¨çº¿â‰¤20äºº
- **ç»„ç»‡æ¶æ„**: å°æ¹¾/å¤§é™†åˆ†å…¬å¸ â†’ äº‹ä¸šéƒ¨ â†’ éƒ¨é—¨ â†’ è¯¾åˆ«
- **éƒ¨ç½²ç¯å¢ƒ**: Windows Server + IIS + å†…ç½‘

### 1.2 æŠ€æœ¯æ ˆ
```
å‰ç«¯: React 19 + TypeScript + Carbon Design (å·²å®Œæˆ)
åç«¯: C# + .NET Core 8 + Web API + Swagger UI
è®¤è¯: JWT Token + RBACæƒé™
æ•°æ®: SqlSugar ORM + MySQL 8.0
éƒ¨ç½²: Windows Server + IIS
```

### 1.3 æ ¸å¿ƒåŠŸèƒ½

#### å±‚çº§ç»“æ„ï¼ˆé‡è¦ä¿®æ­£ï¼‰
**4å±‚å±‚çº§ç»“æ„**ï¼š
1. **äº§å“ç±»å‹** (ProductType): PCBã€FPCç­‰
2. **æœºå‹åˆ†ç±»** (ModelClassification): SLU-ã€SLUR-ã€SB-ã€ST-ã€AC-ç­‰
3. **ä»£ç åˆ†ç±»** (CodeClassification): 1-å†…å±‚ã€2-è–„æ¿ã€3-è½½ç›˜ç­‰ï¼ˆå¯é€‰å±‚ï¼‰
4. **ä»£ç ä½¿ç”¨æ¸…å•** (CodeUsageEntry): å…·ä½“çš„ç¼–ç è®°å½•

**ä¸¤ç§æ¶æ„æ¨¡å¼**ï¼š
- **3å±‚ç»“æ„**: äº§å“ç±»å‹ â†’ æœºå‹åˆ†ç±»(hasCodeClassification=true) â†’ ä»£ç åˆ†ç±» â†’ ä½¿ç”¨æ¸…å•
- **2å±‚ç»“æ„**: äº§å“ç±»å‹ â†’ æœºå‹åˆ†ç±»(hasCodeClassification=false) â†’ ä½¿ç”¨æ¸…å•

---

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        FE[React 19 SPA<br/>Carbon Design<br/>TypeScript]
    end
    
    subgraph "åº”ç”¨å±‚"
        API[.NET Core 8 API<br/>Controllers]
        AUTH[JWTè®¤è¯ä¸­é—´ä»¶<br/>RBACæƒé™]
        SWAGGER[Swagger UI<br/>APIæ–‡æ¡£]
    end
    
    subgraph "ä¸šåŠ¡å±‚"
        BIZ[ä¸šåŠ¡æœåŠ¡å±‚<br/>Services]
        DTO[æ•°æ®ä¼ è¾“å¯¹è±¡<br/>DTOs]
        EVENT[äº‹ä»¶æ€»çº¿<br/>EventBus]
    end
    
    subgraph "æ•°æ®å±‚"
        ORM[SqlSugar ORM<br/>Repository]
        DB[(MySQL 8.0<br/>æ•°æ®åº“)]
    end
    
    FE -->|HTTPS| API
    API --> AUTH
    API --> SWAGGER
    API --> BIZ
    BIZ --> DTO
    BIZ --> EVENT
    BIZ --> ORM
    ORM --> DB
```

---

## 3. æ•°æ®åº“è®¾è®¡ï¼ˆä¿®æ­£ç‰ˆï¼‰

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

#### äº§å“å’Œæœºå‹ç›¸å…³è¡¨
```sql
-- äº§å“ç±»å‹è¡¨
CREATE TABLE ProductTypes (
    Id INT PRIMARY KEY IDENTITY,
    Code NVARCHAR(20) NOT NULL UNIQUE,  -- PCB, FPCç­‰
    Name NVARCHAR(100) NOT NULL,
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE()
);

-- æœºå‹åˆ†ç±»è¡¨ï¼ˆé‡è¦ï¼šè¿™æ˜¯SLU-ã€SLUR-ç­‰çš„æ¥æºï¼‰
CREATE TABLE ModelClassifications (
    Id INT PRIMARY KEY IDENTITY,
    Type NVARCHAR(20) NOT NULL,          -- SLU-, SLUR-, SB-, ST-, AC-ç­‰
    Name NVARCHAR(100) NOT NULL,         -- è£½ç¨‹æŠ•æ”¶æ–™éå¤šè»¸æ©Ÿæ¢°æ‰‹ç­‰
    Description TEXT,                     -- JSONæ ¼å¼çš„æè¿°æ•°ç»„
    ProductTypeId INT NOT NULL,          -- å…³è”åˆ°ProductTypes
    HasCodeClassification BIT DEFAULT 1, -- æ˜¯å¦æœ‰ä»£ç åˆ†ç±»å±‚ï¼ˆ3å±‚/2å±‚ç»“æ„ï¼‰
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    FOREIGN KEY (ProductTypeId) REFERENCES ProductTypes(Id)
);

-- ä»£ç åˆ†ç±»è¡¨ï¼ˆä»…3å±‚ç»“æ„ä½¿ç”¨ï¼‰
CREATE TABLE CodeClassifications (
    Id INT PRIMARY KEY IDENTITY,
    Code NVARCHAR(50) NOT NULL,          -- 1-å†…å±‚, 2-è–„æ¿, 3-è½½ç›˜ç­‰
    Name NVARCHAR(100) NOT NULL,
    ModelClassificationId INT NOT NULL,  -- å…³è”åˆ°ModelClassifications
    SortOrder INT,
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    FOREIGN KEY (ModelClassificationId) REFERENCES ModelClassifications(Id)
);

-- ç¼–ç ä½¿ç”¨è®°å½•è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰
CREATE TABLE CodeUsageEntries (
    Id INT PRIMARY KEY IDENTITY,
    -- ç¼–ç ç»„æˆéƒ¨åˆ†
    Model NVARCHAR(50) NOT NULL,             -- å®Œæ•´ç¼–ç : SLU-105A
    ModelType NVARCHAR(20) NOT NULL,         -- æœºå‹ç±»å‹: SLU- (æ¥è‡ªModelClassifications.Type)
    CodeClassificationNumber INT NULL,       -- ä»£ç åˆ†ç±»æ•°å­—: 1 (æ¥è‡ª"1-å†…å±‚"ï¼Œ2å±‚ç»“æ„æ—¶ä¸ºNULL)
    ActualNumber NVARCHAR(10) NOT NULL,      -- å®é™…ç¼–å·: 05
    Extension NVARCHAR(10),                  -- å»¶ä¼¸ç : A
    
    -- å…³è”å­—æ®µ
    ModelClassificationId INT NOT NULL,      -- å…³è”çš„æœºå‹åˆ†ç±»
    CodeClassificationId INT NULL,           -- å…³è”çš„ä»£ç åˆ†ç±»(2å±‚ç»“æ„æ—¶ä¸ºNULL)
    
    -- ä¸šåŠ¡å­—æ®µ
    ProductName NVARCHAR(200),               -- å“å
    Description TEXT,                        -- è¯´æ˜
    OccupancyType NVARCHAR(20),             -- å ç”¨ç±»å‹: 'è§„åˆ’'/'æš‚åœ'/'å·¥ä»¤'
    CustomerId INT,
    FactoryId INT,
    Builder NVARCHAR(100),                  -- å»ºæ¡£äºº
    Requester NVARCHAR(100),                -- éœ€æ±‚äºº
    CreationDate DATE,
    
    -- çŠ¶æ€å­—æ®µ
    IsAllocated BIT DEFAULT 0,              -- 0=é¢„åˆ†é…ï¼Œ1=å·²ä½¿ç”¨
    IsDeleted BIT DEFAULT 0,
    DeletedReason NVARCHAR(200),
    NumberDigits INT NOT NULL,              -- åˆ›å»ºæ—¶çš„ç¼–å·ä½æ•°
    
    -- å®¡è®¡å­—æ®µ
    CreatedBy INT,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    UpdatedAt DATETIME2 DEFAULT GETDATE(),
    
    FOREIGN KEY (ModelClassificationId) REFERENCES ModelClassifications(Id),
    FOREIGN KEY (CodeClassificationId) REFERENCES CodeClassifications(Id)
);

-- ç¼–ç é¢„åˆ†é…æ—¥å¿—è¡¨
CREATE TABLE CodePreAllocationLogs (
    Id INT PRIMARY KEY IDENTITY,
    ModelClassificationId INT NOT NULL,      -- æœºå‹åˆ†ç±»ID
    CodeClassificationId INT NOT NULL,       -- ä»£ç åˆ†ç±»ID
    ModelType NVARCHAR(20) NOT NULL,         -- æœºå‹ç±»å‹(å¦‚SLU-)
    ClassificationNumber INT NOT NULL,       -- ä»£ç åˆ†ç±»ç¼–å·(å¦‚1)
    AllocationCount INT NOT NULL,            -- é¢„åˆ†é…æ•°é‡
    NumberDigits INT NOT NULL,               -- ä½¿ç”¨çš„ç¼–å·ä½æ•°
    StartCode NVARCHAR(50) NOT NULL,         -- èµ·å§‹ç¼–ç 
    EndCode NVARCHAR(50) NOT NULL,           -- ç»“æŸç¼–ç 
    CreatedBy INT NOT NULL,
    CreatedAt DATETIME2 DEFAULT GETDATE()
);
```

### 3.2 æ•°æ®ç¤ºä¾‹è¯´æ˜

#### ç¼–ç ç»“æ„åˆ†è§£ï¼ˆä¿®æ­£ç‰ˆï¼‰

**3å±‚ç»“æ„ç¤ºä¾‹: SLU-105A**
```
SLU-105A åˆ†è§£ä¸º:
â”œâ”€â”€ SLU-    : æœºå‹åˆ†ç±»Type (æ¥è‡ªModelClassificationsè¡¨)
â”œâ”€â”€ 1       : ä»£ç åˆ†ç±»ç¼–å· (æ¥è‡ªCodeClassifications "1-å†…å±‚")
â”œâ”€â”€ 05      : å®é™…ç¼–å·
â””â”€â”€ A       : å»¶ä¼¸ç 

æ•°æ®åº“å­˜å‚¨:
- Model: "SLU-105A"
- ModelType: "SLU-"
- CodeClassificationNumber: 1
- ActualNumber: "05"
- Extension: "A"
- ModelClassificationId: [å¯¹åº”SLU-çš„ID]
- CodeClassificationId: [å¯¹åº”"1-å†…å±‚"çš„ID]
```

**2å±‚ç»“æ„ç¤ºä¾‹: AC-001B**
```
AC-001B åˆ†è§£ä¸º:
â”œâ”€â”€ AC-     : æœºå‹åˆ†ç±»Type (æ¥è‡ªModelClassificationsè¡¨)
â”œâ”€â”€ 001     : ç¼–å·éƒ¨åˆ†
â””â”€â”€ B       : å»¶ä¼¸ç 

æ•°æ®åº“å­˜å‚¨:
- Model: "AC-001B"
- ModelType: "AC-"
- CodeClassificationNumber: NULL
- ActualNumber: "001"
- Extension: "B"
- ModelClassificationId: [å¯¹åº”AC-çš„ID]
- CodeClassificationId: NULL
```

---

## 4. APIè®¾è®¡è§„èŒƒ

### 4.1 ç»Ÿä¸€è·¯å¾„è§„èŒƒ

**æ‰€æœ‰APIå¿…é¡»ä½¿ç”¨ `/api/v1/` å‰ç¼€**

### 4.2 ä¸»è¦APIç«¯ç‚¹ï¼ˆä¿®æ­£ç‰ˆï¼‰

| åŠŸèƒ½æ¨¡å— | HTTPæ–¹æ³• | ç«¯ç‚¹è·¯å¾„ | è¯´æ˜ |
|---------|---------|---------|------|
| äº§å“ç±»å‹ | GET | `/api/v1/product-types` | è·å–æ‰€æœ‰äº§å“ç±»å‹ |
| æœºå‹åˆ†ç±» | GET | `/api/v1/model-classifications` | è·å–æœºå‹åˆ†ç±»åˆ—è¡¨ |
| æœºå‹åˆ†ç±» | GET | `/api/v1/model-classifications/by-product/{productType}` | æŒ‰äº§å“ç±»å‹è·å–æœºå‹åˆ†ç±» |
| ä»£ç åˆ†ç±» | GET | `/api/v1/code-classifications/by-model/{modelType}` | æŒ‰æœºå‹è·å–ä»£ç åˆ†ç±» |
| ç¼–ç ä½¿ç”¨ | GET | `/api/v1/code-usage/by-classification/{classificationId}` | è·å–ç¼–ç åˆ—è¡¨ |
| é¢„åˆ†é… | POST | `/api/v1/code-preallocation/allocate` | é¢„åˆ†é…ç¼–ç  |

### 4.3 DTOè®¾è®¡ï¼ˆä¿®æ­£ç‰ˆï¼‰

```csharp
// æœºå‹åˆ†ç±»DTO
public class ModelClassificationDto
{
    public int Id { get; set; }
    public string Type { get; set; }           // SLU-, SLUR-ç­‰
    public string Name { get; set; }           // ä¸­æ–‡åç§°
    public List<string> Description { get; set; } // æè¿°æ•°ç»„
    public string ProductType { get; set; }    // äº§å“ç±»å‹Code(PCB/FPC)
    public bool HasCodeClassification { get; set; } // æ˜¯å¦æœ‰ä»£ç åˆ†ç±»
}

// ä»£ç åˆ†ç±»DTO
public class CodeClassificationDto
{
    public int Id { get; set; }
    public string Code { get; set; }           // 1-å†…å±‚, 2-è–„æ¿ç­‰
    public string Name { get; set; }
    public string ModelType { get; set; }      // å…³è”çš„æœºå‹Type(SLU-)
    public int SortOrder { get; set; }
}

// ç¼–ç ä½¿ç”¨DTO
public class CodeUsageEntryDto
{
    public int Id { get; set; }
    public string Model { get; set; }          // å®Œæ•´ç¼–ç 
    public string ModelType { get; set; }      // æœºå‹ç±»å‹
    public string CodeClassification { get; set; } // ä»£ç åˆ†ç±»(å¦‚"1-å†…å±‚")
    public string ActualNumber { get; set; }   // å®é™…ç¼–å·
    public string Extension { get; set; }      // å»¶ä¼¸ç 
    public string ProductName { get; set; }
    public string Description { get; set; }
    public string OccupancyType { get; set; }
    public bool IsAllocated { get; set; }
}
```

---

## 5. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆä¿®æ­£ç‰ˆï¼‰

### 5.1 ç¼–ç ç»“æ„è®¾è®¡

#### å®Œæ•´çš„å±‚çº§å…³ç³»
```
äº§å“ç±»å‹ (ProductType)
    â””â”€â”€ æœºå‹åˆ†ç±» (ModelClassification) 
            â”œâ”€â”€ [3å±‚ç»“æ„] ä»£ç åˆ†ç±» (CodeClassification)
            â”‚       â””â”€â”€ ä»£ç ä½¿ç”¨æ¸…å• (CodeUsageEntry)
            â””â”€â”€ [2å±‚ç»“æ„] ä»£ç ä½¿ç”¨æ¸…å• (CodeUsageEntry)
```

#### 3å±‚ç»“æ„ï¼ˆæœ‰ä»£ç åˆ†ç±»ï¼‰
```
ç¤ºä¾‹: PCB â†’ SLU- â†’ 1-å†…å±‚ â†’ SLU-105A
- äº§å“ç±»å‹: PCB
- æœºå‹åˆ†ç±»: SLU- (è£½ç¨‹æŠ•æ”¶æ–™éå¤šè»¸æ©Ÿæ¢°æ‰‹)
- ä»£ç åˆ†ç±»: 1-å†…å±‚
- å®Œæ•´ç¼–ç : SLU-105A
    â”œâ”€â”€ SLU-: æ¥è‡ªæœºå‹åˆ†ç±»
    â”œâ”€â”€ 1: æ¥è‡ªä»£ç åˆ†ç±»ç¼–å·
    â”œâ”€â”€ 05: å®é™…ç¼–å·
    â””â”€â”€ A: å»¶ä¼¸ç 
```

#### 2å±‚ç»“æ„ï¼ˆæ— ä»£ç åˆ†ç±»ï¼‰
```
ç¤ºä¾‹: FPC â†’ AC- â†’ AC-001B
- äº§å“ç±»å‹: FPC
- æœºå‹åˆ†ç±»: AC- (ç©ºèª¿è¨­å‚™, hasCodeClassification=false)
- å®Œæ•´ç¼–ç : AC-001B
    â”œâ”€â”€ AC-: æ¥è‡ªæœºå‹åˆ†ç±»
    â”œâ”€â”€ 001: ç¼–å·éƒ¨åˆ†
    â””â”€â”€ B: å»¶ä¼¸ç 
```

### 5.2 ç¼–ç åˆ›å»ºæœºåˆ¶ï¼ˆä¿®æ­£ç‰ˆï¼‰

#### 3å±‚ç»“æ„æµç¨‹
1. é€‰æ‹©äº§å“ç±»å‹ï¼ˆå¦‚PCBï¼‰
2. é€‰æ‹©æœºå‹åˆ†ç±»ï¼ˆå¦‚SLU-ï¼‰
3. åˆ›å»ºä»£ç åˆ†ç±»ï¼ˆå¦‚"1-å†…å±‚"ï¼‰æ—¶ï¼š
   - ç³»ç»Ÿè‡ªåŠ¨é¢„åˆ†é…SLU-100, SLU-101, ..., SLU-199
   - æ‰€æœ‰ç¼–ç åˆå§‹çŠ¶æ€IsAllocated=false
4. ç”¨æˆ·é€‰æ‹©é¢„åˆ†é…çš„ç¼–ç ï¼ˆå¦‚SLU-105ï¼‰
5. å¡«å†™ä¸šåŠ¡ä¿¡æ¯å’Œå»¶ä¼¸ç ï¼ˆå¯é€‰ï¼‰
6. ä¿å­˜åè®¾ç½®IsAllocated=true

#### 2å±‚ç»“æ„æµç¨‹
1. é€‰æ‹©äº§å“ç±»å‹ï¼ˆå¦‚FPCï¼‰
2. é€‰æ‹©æœºå‹åˆ†ç±»ï¼ˆå¦‚AC-ï¼ŒhasCodeClassification=falseï¼‰
3. ç›´æ¥è¿›å…¥ç¼–ç åˆ›å»ºï¼š
   - ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ç¼–å·ï¼ˆå¦‚001ï¼‰
   - è¾“å…¥å»¶ä¼¸ç ï¼ˆå¯é€‰ï¼Œå¦‚Bï¼‰
   - ç³»ç»Ÿç”Ÿæˆå®Œæ•´ç¼–ç AC-001B
4. ç›´æ¥åˆ›å»ºå¹¶è®¾ç½®IsAllocated=true

---

## 6. ç¼–ç è§„åˆ™é…ç½®ï¼ˆä¿®æ­£ç‰ˆï¼‰

### 6.1 é¢„åˆ†é…ç®—æ³•ï¼ˆ3å±‚ç»“æ„ä¸“ç”¨ï¼‰

```csharp
public class PreAllocationService : IPreAllocationService
{
    public async Task PreAllocateCodesAsync(
        int modelClassificationId, 
        int codeClassificationId,
        string codeClassificationCode) // "1-å†…å±‚"
    {
        // è·å–æœºå‹åˆ†ç±»ä¿¡æ¯
        var modelClassification = await _db.Queryable<ModelClassification>()
            .FirstAsync(m => m.Id == modelClassificationId);
            
        var modelType = modelClassification.Type; // "SLU-"
        
        // æå–ä»£ç åˆ†ç±»ç¼–å·
        var classificationNumber = ExtractNumberFromCode(codeClassificationCode); // 1
        
        // è·å–ç¼–å·ä½æ•°é…ç½®
        var numberDigits = await GetCurrentNumberDigitsAsync(); // 2ä½
        var maxNumber = (int)Math.Pow(10, numberDigits) - 1; // 99
        
        var preallocatedCodes = new List<CodeUsageEntry>();
        
        for (int i = 0; i <= maxNumber; i++)
        {
            var actualNumber = i.ToString(new string('0', numberDigits)); // 00, 01, 02...
            var fullModel = $"{modelType}{classificationNumber}{actualNumber}"; // SLU-100, SLU-101...
            
            preallocatedCodes.Add(new CodeUsageEntry
            {
                Model = fullModel,
                ModelType = modelType,
                CodeClassificationNumber = classificationNumber,
                ActualNumber = actualNumber,
                Extension = null,
                ModelClassificationId = modelClassificationId,
                CodeClassificationId = codeClassificationId,
                IsAllocated = false,
                NumberDigits = numberDigits
            });
        }
        
        await _db.Insertable(preallocatedCodes).ExecuteCommandAsync();
        
        // è®°å½•é¢„åˆ†é…æ—¥å¿—
        await LogPreAllocationAsync(modelClassificationId, codeClassificationId, 
            modelType, classificationNumber, preallocatedCodes.Count);
    }
}
```

### 6.2 æ‰‹åŠ¨ç¼–ç åˆ›å»ºï¼ˆ2å±‚ç»“æ„ä¸“ç”¨ï¼‰

```csharp
public async Task<bool> CreateManualCodeAsync(
    int modelClassificationId,
    string numberPart, 
    string extension,
    CreateCodeDto dto)
{
    // è·å–æœºå‹åˆ†ç±»ä¿¡æ¯
    var modelClassification = await _db.Queryable<ModelClassification>()
        .FirstAsync(m => m.Id == modelClassificationId);
        
    var modelType = modelClassification.Type; // "AC-"
    
    // éªŒè¯ç¼–å·æ ¼å¼
    var numberDigits = await GetCurrentNumberDigitsAsync();
    if (numberPart.Length != numberDigits || !numberPart.All(char.IsDigit))
        return false;
    
    // éªŒè¯å»¶ä¼¸ç 
    if (!string.IsNullOrEmpty(extension))
    {
        var excludedChars = await GetExcludedCharsAsync();
        if (extension.Any(c => excludedChars.Contains(c)))
            return false;
    }
    
    // æ„é€ å®Œæ•´ç¼–ç 
    var fullModel = $"{modelType}{numberPart}{extension ?? ""}"; // AC-001B
    
    // æ£€æŸ¥å”¯ä¸€æ€§
    if (await CheckCodeExistsAsync(fullModel))
        return false;
    
    // åˆ›å»ºè®°å½•
    var codeEntry = new CodeUsageEntry
    {
        Model = fullModel,
        ModelType = modelType,
        CodeClassificationNumber = null, // 2å±‚ç»“æ„æ— ä»£ç åˆ†ç±»
        ActualNumber = numberPart,
        Extension = extension,
        ModelClassificationId = modelClassificationId,
        CodeClassificationId = null, // 2å±‚ç»“æ„è®¾ä¸ºNULL
        ProductName = dto.ProductName,
        Description = dto.Description,
        OccupancyType = dto.OccupancyType,
        IsAllocated = true, // æ‰‹åŠ¨åˆ›å»ºç›´æ¥æ ‡è®°ä¸ºå·²ä½¿ç”¨
        NumberDigits = numberDigits
    };
    
    await _db.Insertable(codeEntry).ExecuteCommandAsync();
    return true;
}
```

---

## 7. çŠ¶æ€ç®¡ç†ä¸ç›‘æ§

### 7.1 çŠ¶æ€å®šä¹‰

**å ç”¨ç±»å‹** (OccupancyType): ä¸­æ–‡å€¼ï¼Œç”¨äºä¸šåŠ¡æ˜¾ç¤º
- `è§„åˆ’`
- `æš‚åœ`
- `å·¥ä»¤`

**ç›‘æ§çŠ¶æ€** (MonitorStatus): è‹±æ–‡å€¼ï¼Œç”¨äºç³»ç»Ÿå¤„ç†
- `Active`
- `Paused`
- `Stopped`

### 7.2 çŠ¶æ€è½¬æ¢è§„åˆ™

| åŸçŠ¶æ€ | æ–°çŠ¶æ€ | MonitorStatuså˜åŒ– | MonitorStartTime | StopReason |
|--------|--------|-------------------|------------------|------------|
| è§„åˆ’ | æš‚åœ | Active â†’ Paused | ä¿ç•™åŸå€¼ | NULL |
| è§„åˆ’ | å·¥ä»¤ | Active â†’ Stopped | ä¿ç•™åŸå€¼ | "çŠ¶æ€å˜æ›´ä¸ºå·¥ä»¤" |
| æš‚åœ | è§„åˆ’ | Paused â†’ Active | é‡ç½®ä¸ºå½“å‰æ—¶é—´ | NULL |
| æš‚åœ | å·¥ä»¤ | Paused â†’ Stopped | ä¿ç•™åŸå€¼ | "çŠ¶æ€å˜æ›´ä¸ºå·¥ä»¤" |
| å·¥ä»¤ | è§„åˆ’ | åˆ›å»ºæ–°è®°å½•ï¼ŒActive | å½“å‰æ—¶é—´ | NULL |
| å·¥ä»¤ | æš‚åœ | åˆ›å»ºæ–°è®°å½•ï¼ŒPaused | å½“å‰æ—¶é—´ | NULL |

---

## 8. æœåŠ¡å±‚è®¾è®¡ï¼ˆä¿®æ­£ç‰ˆï¼‰

### 8.1 æœåŠ¡æ¥å£å®šä¹‰

```csharp
// æœºå‹åˆ†ç±»æœåŠ¡
public interface IModelClassificationService
{
    Task<IEnumerable<ModelClassificationDto>> GetByProductTypeAsync(string productType);
    Task<ModelClassificationDto> GetByIdAsync(int id);
    Task<ModelClassificationDto> CreateAsync(CreateModelClassificationDto dto);
}

// ä»£ç åˆ†ç±»æœåŠ¡
public interface ICodeClassificationService
{
    Task<IEnumerable<CodeClassificationDto>> GetByModelTypeAsync(string modelType);
    Task<CodeClassificationDto> CreateAsync(CreateCodeClassificationDto dto);
    Task PreAllocateCodesAsync(int codeClassificationId); // åˆ›å»ºæ—¶è§¦å‘é¢„åˆ†é…
}

// ç¼–ç ä½¿ç”¨æœåŠ¡
public interface ICodeUsageService
{
    Task<PagedResult<CodeUsageEntryDto>> GetByClassificationAsync(
        int? codeClassificationId, 
        int? modelClassificationId,
        QueryDto query);
    Task<CodeUsageEntryDto> AllocateCodeAsync(int codeId, AllocateDto dto);
    Task<CodeUsageEntryDto> CreateManualCodeAsync(CreateManualCodeDto dto);
}
```

### 8.2 æœåŠ¡å®ç°è¦ç‚¹

```csharp
public class CodeClassificationService : ICodeClassificationService
{
    public async Task<CodeClassificationDto> CreateAsync(CreateCodeClassificationDto dto)
    {
        // 1. åˆ›å»ºä»£ç åˆ†ç±»
        var codeClassification = new CodeClassification
        {
            Code = dto.Code, // "1-å†…å±‚"
            Name = dto.Name,
            ModelClassificationId = dto.ModelClassificationId,
            SortOrder = dto.SortOrder
        };
        
        await _db.Insertable(codeClassification).ExecuteCommandAsync();
        
        // 2. è·å–æœºå‹åˆ†ç±»ä¿¡æ¯
        var modelClassification = await _db.Queryable<ModelClassification>()
            .FirstAsync(m => m.Id == dto.ModelClassificationId);
        
        // 3. å¦‚æœæ˜¯3å±‚ç»“æ„ï¼Œè§¦å‘é¢„åˆ†é…
        if (modelClassification.HasCodeClassification)
        {
            await _preAllocationService.PreAllocateCodesAsync(
                modelClassification.Id,
                codeClassification.Id,
                codeClassification.Code
            );
        }
        
        return MapToDto(codeClassification);
    }
}
```

---

## 9. æƒé™ç®¡ç†

### 9.1 RBACæƒé™æ¨¡å‹

```
è§’è‰²å®šä¹‰:
â”œâ”€â”€ è¶…çº§ç®¡ç†å‘˜ (SuperAdmin) - 2äºº
â”‚   â””â”€â”€ å…¨éƒ¨æƒé™ï¼ˆåŒ…æ‹¬ç³»ç»Ÿé…ç½®ã€ç¼–ç è§„åˆ™é…ç½®ï¼‰
â”œâ”€â”€ ç®¡ç†å‘˜ (Admin) - â‰¤5äºº
â”‚   â””â”€â”€ ç¼–ç ç”³è¯·ã€å®¡æ ¸ã€éƒ¨é—¨æ•°æ®ç®¡ç†
â””â”€â”€ æ™®é€šç”¨æˆ· (User) - ~195äºº
    â””â”€â”€ ä»…æŸ¥çœ‹æƒé™
```

---

## 10. éƒ¨ç½²æ–¹æ¡ˆ

### 10.1 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

```sql
-- æ’å…¥äº§å“ç±»å‹
INSERT INTO ProductTypes (Code, Name) VALUES 
('PCB', 'PCBæ¿'),
('FPC', 'FPCæŸ”æ€§æ¿');

-- æ’å…¥æœºå‹åˆ†ç±»
INSERT INTO ModelClassifications (Type, Name, Description, ProductTypeId, HasCodeClassification) VALUES 
('SLU-', 'è£½ç¨‹æŠ•æ”¶æ–™éå¤šè»¸æ©Ÿæ¢°æ‰‹', '["è£½ç¨‹æŠ•æ”¶æ–™", "éå¤šè»¸æ©Ÿæ¢°æ‰‹"]', 1, 1),
('SLUR-', 'è£½ç¨‹æŠ•æ”¶æ–™å¤šè»¸æ©Ÿæ¢°æ‰‹', '["è£½ç¨‹æŠ•æ”¶æ–™", "å¤šè»¸æ©Ÿæ¢°æ‰‹"]', 1, 1),
('SB-', 'é€æ¿æ©Ÿ', '["é€æ¿æ©Ÿ"]', 1, 1),
('ST-', 'å †ç–Šæ©Ÿ', '["å †ç–Šæ©Ÿ"]', 1, 1),
('AC-', 'ç©ºèª¿è¨­å‚™', '["ç©ºèª¿è¨­å‚™", "ç’°å¢ƒæ§åˆ¶"]', 2, 0); -- 2å±‚ç»“æ„

-- ç³»ç»Ÿé…ç½®
INSERT INTO SystemConfigs (ConfigKey, ConfigValue, Description) VALUES 
('NumberDigits', '2', 'ç¼–å·ä½æ•°ï¼Œ2-9ä½'),
('ExtensionMaxLength', '1', 'å»¶ä¼¸ç æœ€å¤§é•¿åº¦'),
('ExtensionExcludedChars', 'I,L,O', 'å»¶ä¼¸ç æ’é™¤å­—ç¬¦');
```

---

## ğŸ“ é‡è¦ä¿®æ­£è¯´æ˜

### ä¸»è¦ä¿®æ­£å†…å®¹ï¼š

1. **å±‚çº§ç»“æ„ç†è§£**ï¼š
   - æ˜ç¡®äº†æ˜¯4å±‚ç»“æ„ï¼šäº§å“ç±»å‹ â†’ æœºå‹åˆ†ç±» â†’ ä»£ç åˆ†ç±»(å¯é€‰) â†’ ä½¿ç”¨æ¸…å•
   - SLU-ç­‰æ¥è‡ª**æœºå‹åˆ†ç±»è¡¨**ï¼Œä¸æ˜¯ç¡¬ç¼–ç çš„å‰ç¼€
   - ä»£ç åˆ†ç±»ä¸­çš„æ•°å­—(1,2,3)æ¥è‡ª**ä»£ç åˆ†ç±»è¡¨**

2. **ç¼–ç ç»„æˆä¿®æ­£**ï¼š
   - SLU-105A = æœºå‹åˆ†ç±»(SLU-) + ä»£ç åˆ†ç±»ç¼–å·(1) + å®é™…ç¼–å·(05) + å»¶ä¼¸ç (A)
   - AC-001B = æœºå‹åˆ†ç±»(AC-) + ç¼–å·(001) + å»¶ä¼¸ç (B)

3. **æ•°æ®åº“è®¾è®¡ä¼˜åŒ–**ï¼š
   - æ·»åŠ äº†ModelClassificationIdå­—æ®µåˆ°CodeUsageEntriesè¡¨
   - æ˜ç¡®äº†ModelTypeå­—æ®µå­˜å‚¨æœºå‹åˆ†ç±»çš„Typeå€¼
   - CodeClassificationNumberå¯ä¸ºNULLï¼ˆ2å±‚ç»“æ„æ—¶ï¼‰

4. **APIè®¾è®¡è°ƒæ•´**ï¼š
   - æŒ‰äº§å“ç±»å‹è·å–æœºå‹åˆ†ç±»
   - æŒ‰æœºå‹è·å–ä»£ç åˆ†ç±»
   - æ”¯æŒ2å±‚å’Œ3å±‚ç»“æ„çš„ä¸åŒæµç¨‹

---

**æ–‡æ¡£çŠ¶æ€**: å®Œæ•´ç‰ˆï¼ˆå·²ä¿®æ­£ç¼–ç ç»“æ„ç†è§£ï¼‰  
**ç»´æŠ¤äºº**: æŠ€æœ¯è´Ÿè´£äºº  
**æœ€åæ›´æ–°**: 2025å¹´8æœˆ16æ—¥  
**ç‰ˆæœ¬**: v3.0